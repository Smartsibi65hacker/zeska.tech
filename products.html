<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zeska Billing - Product List</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background: #f8f9fa; }
    .card { border-radius: 10px; margin-bottom: 15px; }
    .header { background: #0d6efd; color: white; padding: 15px; border-radius: 10px 10px 0 0; }
    .delete-btn { color: red; cursor: pointer; }
    .edit-btn { color: orange; cursor: pointer; margin-right: 10px; }
  </style>
</head>
<body class="p-4">

  <div class="container bg-white p-4 shadow rounded">
    <h3 class="text-center mb-4">üì¶ Product List</h3>

    <!-- Add Product (Admin only) -->
    <div id="addProductRow" class="mb-3" style="display:none;">
      <div class="row g-2">
        <div class="col-md-6">
          <input id="newProduct" class="form-control" placeholder="Enter new product name">
        </div>
        <div class="col-md-3">
          <input id="newQuantity" type="number" min="1" class="form-control" placeholder="Quantity">
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100" onclick="addProduct()">+ Add</button>
        </div>
      </div>
    </div>

    <!-- Product Table -->
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Product Name</th>
          <th>Quantity</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="productList"></tbody>
    </table>

    <div class="text-center mt-3">
      <button class="btn btn-secondary" onclick="goBack()">‚¨Ö Back to Portal</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ‚úÖ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCycwfIfSaNsNW8wPqBZL27Z4PJAXB2WIU",
      authDomain: "zeska-billing.firebaseapp.com",
      projectId: "zeska-billing",
      storageBucket: "zeska-billing.firebasestorage.app",
      messagingSenderId: "285841508539",
      appId: "1:285841508539:web:0e7d0b64be33693a4a019e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const adminUIDs = [
      "hCQy8CJt4YXOxYMehNbsLQ1WjCk1",
      "Pmibt2j3XyfLrujCbLrDbgm5l692",
      "qmIuS4rZWjcmCKCTCHXuQL1eciH3"
    ];
    let currentUser = null;

    // ‚úÖ Load Products
    async function loadProducts() {
      const table = document.getElementById("productList");
      table.innerHTML = "";

      const snap = await getDocs(collection(db, "products"));
      let i = 1;
      snap.forEach(p => {
        const data = p.data();
        table.innerHTML += `
          <tr>
            <td>${i++}</td>
            <td>${p.id}</td>
            <td>${data.quantity || 0}</td>
            <td>
              ${adminUIDs.includes(currentUser.uid) 
                ? `<span class="edit-btn" onclick="editProductQty('${p.id}', ${data.quantity || 0})">‚úèÔ∏è Edit</span>
                   <span class="delete-btn" onclick="deleteProduct('${p.id}')">üóë Delete</span>` 
                : "-"}
            </td>
          </tr>
        `;
      });
    }

    // ‚úÖ Add Product (Admin only)
    window.addProduct = async function() {
      let name = document.getElementById("newProduct").value.trim();
      let qty = parseInt(document.getElementById("newQuantity").value.trim()) || 0;

      if (!name) { alert("Enter product name"); return; }
      if (qty <= 0) { alert("Enter valid quantity"); return; }

      await setDoc(doc(db, "products", name), { 
        quantity: qty, 
        createdAt: new Date() 
      });

      document.getElementById("newProduct").value = "";
      document.getElementById("newQuantity").value = "";
      loadProducts();
    };

    // ‚úÖ Delete Product (Admin only)
    window.deleteProduct = async function(name) {
      if (confirm(`Delete product: ${name}?`)) {
        await deleteDoc(doc(db, "products", name));
        loadProducts();
      }
    };

    // ‚úÖ Edit Product Quantity (Admin only)
    window.editProductQty = async function(name, currentQty) {
      let newQty = prompt(`Enter new quantity for ${name}:`, currentQty);
      if(newQty === null) return; // cancelled
      newQty = parseInt(newQty);
      if(isNaN(newQty) || newQty < 0){ alert("Invalid quantity!"); return; }

      await updateDoc(doc(db, "products", name), { quantity: newQty });
      loadProducts();
    };

    // ‚úÖ Auth Check
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;

        // Show add product only if admin
        if (adminUIDs.includes(user.uid)) {
          document.getElementById("addProductRow").style.display = "block";
        }

        loadProducts();
      } else {
        window.location.href = "login.html";
      }
    });

    // ‚úÖ Back to Portal
    window.goBack = function() {
      window.location.href = "portal.html";
    }
  </script>
</body>
</html>
