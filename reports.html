<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zeska Reports</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#f8f9fa; }
    #chartContainer { height:400px; }
  </style>
</head>
<body class="p-4">

  <div class="container bg-white p-4 shadow rounded">
    <h3 class="text-center mb-4">ðŸ“Š Live Sales Reports</h3>

    <!-- Filters -->
    <div class="row mb-3">
      <div class="col-md-3">
        <select id="filterType" class="form-control">
          <option value="daily">Today</option>
          <option value="weekly">This Week</option>
          <option value="monthly">This Month</option>
          <option value="yearly">This Year</option>
        </select>
      </div>
      <div class="col-md-3">
        <input type="date" id="fromDate" class="form-control">
      </div>
      <div class="col-md-3">
        <input type="date" id="toDate" class="form-control">
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100" onclick="downloadReport()">â¬‡ Download PDF</button>
      </div>
    </div>

    <!-- Chart -->
    <div id="chartContainer">
      <canvas id="salesChart"></canvas>
    </div>

    <!-- Summary -->
    <div id="summary" class="mt-3 alert alert-info"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, orderBy, query } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCycwfIfSaNsNW8wPqBZL27Z4PJAXB2WIU",
      authDomain: "zeska-billing.firebaseapp.com",
      projectId: "zeska-billing",
      storageBucket: "zeska-billing.firebasestorage.app",
      messagingSenderId: "285841508539",
      appId: "1:285841508539:web:0e7d0b64be33693a4a019e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let chartCtx=document.getElementById("salesChart").getContext("2d");
    let chart=new Chart(chartCtx,{type:"bar",data:{labels:[],datasets:[{label:"Sales (â‚¹)",data:[],backgroundColor:"rgba(54,162,235,0.7)"}]}});
    let bills=[];

    // âœ… Filter bills by type
    function filterBills(type,fromDate,toDate){
      let now=new Date();
      return bills.filter(b=>{
        let date=b.createdAt?.toDate()||new Date();
        if(fromDate && toDate){
          return date>=new Date(fromDate) && date<=new Date(toDate);
        }
        if(type==="daily") return date.toDateString()===now.toDateString();
        if(type==="weekly"){
          let start=new Date(now); start.setDate(now.getDate()-7);
          return date>=start && date<=now;
        }
        if(type==="monthly") return date.getMonth()===now.getMonth() && date.getFullYear()===now.getFullYear();
        if(type==="yearly") return date.getFullYear()===now.getFullYear();
        return true;
      });
    }

    // âœ… Update chart + summary
    function updateChart(){
      let type=document.getElementById("filterType").value;
      let fromDate=document.getElementById("fromDate").value;
      let toDate=document.getElementById("toDate").value;
      let filtered=filterBills(type,fromDate,toDate);

      let salesByDate={};
      filtered.forEach(b=>{
        let d=b.createdAt?.toDate().toLocaleDateString()||"-";
        if(!salesByDate[d]) salesByDate[d]=0;
        salesByDate[d]+=b.grandTotal;
      });

      chart.data.labels=Object.keys(salesByDate);
      chart.data.datasets[0].data=Object.values(salesByDate);
      chart.update();

      let total=filtered.reduce((sum,b)=>sum+b.grandTotal,0);
      document.getElementById("summary").innerText=`Bills: ${filtered.length} | Total Sales: â‚¹${total}`;
    }

    // âœ… Download PDF
    window.downloadReport=function(){
      const { jsPDF }=window.jspdf;
      const doc=new jsPDF();
      let y=20;
      doc.setFontSize(14);
      doc.text("Zeska Billing - Sales Report",20,y); y+=10;

      let type=document.getElementById("filterType").value;
      let fromDate=document.getElementById("fromDate").value;
      let toDate=document.getElementById("toDate").value;
      let filtered=filterBills(type,fromDate,toDate);
      let total=0;

      filtered.forEach((b,i)=>{
        let d=b.createdAt?.toDate().toLocaleString()||"-";
        doc.setFontSize(10);
        doc.text(`${i+1}. ${b.custName} (${b.custNumber}) - ${d}`,20,y); y+=6;
        doc.text(`Dept: ${b.dept} | Pay: ${b.payment} | By: ${b.createdBy.email} | Total: â‚¹${b.grandTotal}`,20,y); y+=8;
        total+=b.grandTotal;
        if(y>270){ doc.addPage(); y=20; }
      });

      doc.setFontSize(12);
      y+=10; doc.text(`Summary: Bills=${filtered.length}, Total Sales=â‚¹${total}`,20,y); y+=20;

      // Add chart
      let img=document.getElementById("salesChart").toDataURL("image/png");
      doc.addImage(img,"PNG",20,y,160,80);
      doc.save("Sales_Report.pdf");
    }

    // âœ… Live snapshot
    onSnapshot(query(collection(db,"bills"),orderBy("createdAt","desc")),snap=>{
      bills=[];
      snap.forEach(b=>bills.push(b.data()));
      updateChart();
    });

    document.getElementById("filterType").addEventListener("change",updateChart);
    document.getElementById("fromDate").addEventListener("change",updateChart);
    document.getElementById("toDate").addEventListener("change",updateChart);

    onAuthStateChanged(auth,(u)=>{
      if(!u) window.location.href="login.html";
    });
  </script>
</body>
</html>
